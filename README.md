# График смен (sm2)

Веб‑клиент для просмотра и редактирования графика смен с интеграцией через n8n и Pyrus API.

## Авторизация

Поддерживаются два режима, которые не требуют правки кода на фронтенде:

1. **Логин/пароль через n8n `/graph`** (по умолчанию).
   - Форма входа отправляет `type=auth`, `login`, `password` на webhook `graphHookUrl`.
   - n8n возвращает статус и права доступа по линиям.
2. **Автовход по сохранённой сессии** (кеш в браузере).
   - Сессия хранится в `localStorage` и cookie, параметры задаются в `config.json` → `storage.auth`.
   - При истечении `ttlMs` приложение просит логин/пароль снова.

> ⚠️ В интерфейсе остаётся логин/пароль. Любые дополнительные проверки (например, одноразовые коды) реализуются на стороне n8n.

## Требования к n8n

Необходим доступный webhook, указанный в `config.json` → `graphHookUrl`. Он должен принимать POST JSON и обрабатывать следующие типы:

- **`type: "auth"`**
  - Вход: `{ login, password }`
  - Выход: `{ status: "ACCESS_GRANTED", user, permissions }`
    - `permissions` — объект прав по линиям (`ALL`, `L1`, `L2`, `OP`, `OV`, `OU`, `AI`), значения `view|edit`.
  - Примечание: в текущей версии фронта `auth` не вызывается напрямую, но тип разрешён и может использоваться n8n-флоу при необходимости.

- **`type: "pyrus_api"`**
  - Вход: `{ path, method, body? }`
  - Назначение: прокси к Pyrus API (используется в `js/api/pyrusClient.js` и сервисах).
  - Выход: JSON‑ответ Pyrus (как есть).

- **`type: "pyrus_save"`**
  - Вход: `{ changes, meta }`
  - Назначение: сохранение изменений смен (используется в `js/app.js`).

- **`type: "pyrus-api"` (legacy)**
  - Вход: `{ path, method, payload }`
  - Назначение: устаревший прокси к Pyrus API (модули перенесены в `js/legacy`).
  - Выход: `{ success: true, data: <ответ Pyrus> }`.

Также убедитесь, что webhook:
- доступен из браузера (CORS, HTTPS),
- отвечает быстро (таймауты браузера),
- может работать с учётными данными Pyrus (токен/логин в н8н‑креденшелах).

## SMTP / бот‑настройки (n8n)

Фронтенд **не хранит** SMTP‑параметры или токены ботов. Если вы добавляете в n8n:

- отправку одноразовых кодов,
- уведомления по почте,
- авторизацию через бота,

то соответствующие креденшелы должны быть настроены **в n8n** (SMTP, Telegram‑бот, и т. п.). На стороне клиента менять ничего не нужно — достаточно обновить workflow в n8n.

## Структура `config.json`

`config.json` — единственный источник настройки без правки кода. Основные разделы:

- `graphHookUrl` — URL n8n webhook `/graph`.
- `pyrus` — ID каталогов/форм/полей Pyrus:
  - `pyrus.catalogs.shifts`
  - `pyrus.forms.otpusk`, `pyrus.forms.smeni`
  - `pyrus.fields.otpusk.{person,period}`
  - `pyrus.fields.smeni.{person,due,amount,template}`
- `departments` — маппинг отделов по линиям и порядок сортировки.
- `timezone.localOffsetMin` — локальный сдвиг в минутах.
- `ui.lines` — порядок вкладок и отображаемые названия.
- `management.topManagementIds` — список руководителей.
- `pyrusLineItemIdByLine` — ID значения каталога «Линия/Отдел» по линиям.
- `storage` — ключи локального хранения и настройки сессии:
  - `storage.keys.*`
  - `storage.auth.{key,ttlMs,cookieDays}`
- `auth.rolePermissions` — список role id, которым разрешены линии (`ALL`, `L1`, `L2`, `OP`, `OV`, `OU`, `AI`).
- `calendar` — прод‑календарь и UI‑цвета:
  - `calendar.prodCal.{ttlMs,urlTemplate,cacheKeyPrefix}`
  - `calendar.ui.{light,dark}`
  - `calendar.indicators`

Пример секции с правами ролей:

```json
{
  "auth": {
    "rolePermissions": {
      "ALL": [101, 102],
      "L1": [201],
      "L2": [202, 203],
      "OP": [],
      "OV": [],
      "OU": [],
      "AI": []
    }
  }
}
```

## Что можно менять без правки кода

Все перечисленные параметры меняются **только через `config.json`**:

- `graphHookUrl`
- все `pyrus.*`
- `departments.*`
- `timezone.localOffsetMin`
- `ui.lines.*`
- `management.topManagementIds`
- `pyrusLineItemIdByLine.*`
- `storage.keys.*` и `storage.auth.*`
- `auth.rolePermissions.*`
- `calendar.*`

## Откат / совместимость

- Если новые интеграции (SMTP/бот/доп. проверка) выключены в n8n, вход по логину/паролю остаётся **рабочим по умолчанию**.
- Для отката достаточно вернуть прежний `config.json` и/или workflow в n8n — код фронтенда менять не требуется.
- Кеш авторизации можно сбросить кнопкой «Выйти» или очисткой `storage.auth.key` в браузере.

## Архитектура и кеширование

Подробные схемы и описание текущей архитектуры находятся в `/docs`:

- `docs/ARCHITECTURE.md` — структура модулей и зоны ответственности.
- `docs/CACHING.md` — TTL, in-flight dedupe и правила кеша.
- `docs/NETWORK_MAP.md` — карта сетевых запросов и их источники.

## Runtime entrypoints

Runtime entrypoints: `js/app.js` и `js/shift-colors.js`. Всё остальное подключается только через import-цепочку из `app.js`.

## Чек-лист проверки после патча

1. Откройте приложение и пройдите типовой сценарий (логин, загрузка расписания, просмотр смен).
2. DevTools → Network: `/v4/members` должен появиться не более 1 раза за сессию.
3. Быстро переключайте месяцы и возвращайтесь назад — повторных запросов расписания меньше в пределах ~90 секунд.
4. Console: нет ошибок.
5. После сохранения смены происходит повторная загрузка расписания, кеш не мешает обновлению.
6. (Опционально) Проверить принудительное обновление (`force`) — кеш не ломается.
7. Если добавляете новый модуль, он должен быть импортирован из `app.js` или его зависимостей.
